<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tapes Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 20px;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    header .session {
      font-size: 12px;
      color: #666;
      font-family: monospace;
    }

    #clear-btn {
      background: none;
      border: 1px solid #333;
      color: #888;
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    #clear-btn:hover { border-color: #555; color: #ccc; }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 720px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background: #2563eb;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px 12px 2px 12px;
    }

    .message.assistant {
      align-self: flex-start;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px 14px;
      border-radius: 12px 12px 12px 2px;
      border: 1px solid #2a2a2a;
    }

    .message.error {
      align-self: center;
      color: #f87171;
      font-size: 13px;
    }

    #input-area {
      padding: 12px 20px;
      background: #1a1a1a;
      border-top: 1px solid #2a2a2a;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
    }

    #input:focus { border-color: #2563eb; }
    #input::placeholder { color: #555; }

    #send-btn {
      padding: 10px 20px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    #send-btn:hover:not(:disabled) { background: #1d4ed8; }

    .typing-indicator::after {
      content: '...';
      animation: dots 1s steps(3) infinite;
    }

    @keyframes dots {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tapes Chat</h1>
    <span class="session" id="session-display"></span>
    <button id="clear-btn">Clear</button>
  </header>

  <div id="messages"></div>

  <div id="input-area">
    <textarea id="input" rows="1" placeholder="Send a message..." autofocus></textarea>
    <button id="send-btn">Send</button>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    const sessionDisplay = document.getElementById('session-display');

    let sessionId = 'web-' + Date.now();
    let sending = false;

    sessionDisplay.textContent = sessionId;

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'message ' + role;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return div;
    }

    function setInputEnabled(enabled) {
      sending = !enabled;
      sendBtn.disabled = !enabled;
      inputEl.disabled = !enabled;
      if (enabled) inputEl.focus();
    }

    async function send() {
      const text = inputEl.value.trim();
      if (!text || sending) return;

      inputEl.value = '';
      addMessage('user', text);
      setInputEnabled(false);

      const assistantEl = addMessage('assistant', '');
      assistantEl.classList.add('typing-indicator');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, sessionId }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || 'Request failed');
        }

        assistantEl.classList.remove('typing-indicator');

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let content = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          content += decoder.decode(value, { stream: true });
          assistantEl.textContent = content;
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      } catch (err) {
        assistantEl.remove();
        addMessage('error', 'Error: ' + err.message);
      } finally {
        setInputEnabled(true);
      }
    }

    async function clearSession() {
      await fetch('/api/chat', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId }),
      });
      messagesEl.innerHTML = '';
      sessionId = 'web-' + Date.now();
      sessionDisplay.textContent = sessionId;
    }

    sendBtn.addEventListener('click', send);
    clearBtn.addEventListener('click', clearSession);

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Auto-resize textarea
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
    });
  </script>
</body>
</html>
